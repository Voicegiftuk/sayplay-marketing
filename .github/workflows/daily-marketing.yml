name: SayPlay Complete Marketing Automation

on:
  schedule:
    # Runs daily at 9:00 UTC (10:00 GMT, 11:00 BST)
    - cron: '0 9 * * *'
  
  # Allow manual trigger
  workflow_dispatch:

jobs:
  marketing-campaign:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install google-generativeai
          pip install pytrends
          pip install praw
          pip install requests
          pip install pillow
      
      - name: Run Complete Marketing System
        env:
          # AI
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          
          # Shopify Blog
          SHOPIFY_SHOP: ${{ secrets.SHOPIFY_SHOP }}
          SHOPIFY_ACCESS_TOKEN: ${{ secrets.SHOPIFY_ACCESS_TOKEN }}
          SHOPIFY_BLOG_ID: ${{ secrets.SHOPIFY_BLOG_ID }}
          
          # Facebook Page
          FACEBOOK_PAGE_TOKEN: ${{ secrets.FACEBOOK_PAGE_TOKEN }}
          FACEBOOK_PAGE_ID: ${{ secrets.FACEBOOK_PAGE_ID }}
          
          # Instagram Business
          INSTAGRAM_BUSINESS_ID: ${{ secrets.INSTAGRAM_BUSINESS_ID }}
          INSTAGRAM_ACCESS_TOKEN: ${{ secrets.INSTAGRAM_ACCESS_TOKEN }}
          
          # Reddit (optional)
          REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
          REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
        run: |
          python sayplay_complete_system.py
      
      - name: Commit results
        run: |
          git config --global user.name 'SayPlay Marketing Bot'
          git config --global user.email 'marketing@sayplay.co.uk'
          git add -A
          git diff --quiet && git diff --staged --quiet || git commit -m "ðŸ¤– Daily marketing campaign [$(date +'%Y-%m-%d %H:%M UTC')]"
          git push
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: marketing-campaign-${{ github.run_number }}
          path: |
            research_data.json
            generated_content.json
            content_history.json
            sayplay_*.jpg
          retention-days: 30
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "::warning::Marketing campaign failed! Check logs for details."
